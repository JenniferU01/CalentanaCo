<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title><%= title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/main.css" />
</head>
<body>

<header class="header">
  <div class="header-inner">
    <h1 class="logo">
      <img src="/img/logo-calentanaco.png" alt="CalentanaCo" class="logo-img" />
      <span>CalentanaCo · Admin</span>
    </h1>

    <nav class="nav">
      <a href="/admin/dashboard" class="nav-link">Dashboard</a>
      <a href="/admin/company" class="nav-link">Empresa</a>
      <a href="/admin/products" class="nav-link active">Productos</a>
      <a href="/" class="nav-link">Ver sitio</a>
      <a href="/logout" class="nav-link nav-admin">Salir</a>
    </nav>
  </div>
</header>

<main class="main">
  <section class="hero">
    <h2>Editar producto</h2>

    <% if (error) { %>
      <p class="error"><%= error %></p>
    <% } %>

    <form class="form-auth" method="POST" enctype="multipart/form-data">
      <label>
        Nombre
        <input type="text" name="name" required value="<%= product.name %>" />
      </label>

      <label>
        Descripción
        <textarea name="description" rows="4"><%= product.description || "" %></textarea>
      </label>

      <label>
        Categoría
        <select name="category" id="category" required>
          <option value="aguas" <%= product.category === "aguas" ? "selected" : "" %>>Aguas frescas</option>
          <option value="botanas" <%= product.category === "botanas" ? "selected" : "" %>>Botanas</option>
          <option value="antojitos" <%= product.category === "antojitos" ? "selected" : "" %>>Antojitos</option>
        </select>
      </label>

      <!-- =========================
           TAMAÑOS DINÁMICOS
      ========================== -->
      <div class="card">
        <div class="card-head">
          <h3>Tamaños y precios</h3>
          <button type="button" class="btn-secondary" id="btnAddSize">+ Agregar tamaño</button>
        </div>

        <p class="note" style="margin-top:6px;">
          Para aguas es obligatorio tener tamaños (ej. 1/2 Litro $25 y 1 Litro $35).
        </p>

        <div id="sizesWrap" class="sizes-wrap">
          <% 
            const initialSizes = (product.sizes && product.sizes.length) 
              ? product.sizes 
              : [{ label: "1/2 Litro", price: 25 }, { label: "1 Litro", price: 35 }];
          %>

          <% initialSizes.forEach((s, i) => { %>
            <div class="size-row" data-row>
              <div class="size-col">
                <label>
                  Tamaño
                  <input type="text" name="sizes[<%= i %>][label]" value="<%= s.label %>" placeholder="Ej. 1/2 Litro" />
                </label>
              </div>

              <div class="size-col">
                <label>
                  Precio
                  <input type="number" step="0.01" name="sizes[<%= i %>][price]" value="<%= s.price %>" placeholder="Ej. 25" />
                </label>
              </div>

              <div class="size-actions">
                <button type="button" class="btn-danger-outline" data-remove>Quitar</button>
              </div>
            </div>
          <% }) %>
        </div>

        <p class="note">
          Tip: Si un tamaño queda vacío, no se guardará (el backend limpia vacíos).
        </p>
      </div>

      <!-- =========================
           IMAGEN (OPCIÓN A)
      ========================== -->
      <div class="card">
        <h3 style="margin-bottom:8px;">Imagen</h3>

        <% if (product.imageUrl) { %>
          <div style="margin: 10px 0;">
            <img
              src="<%= product.imageUrl %>"
              alt="Imagen actual"
              style="width:100%;max-width:420px;border-radius:12px;border:1px solid #e5e5e5;"
            />
            <p class="note">Si no subes una nueva imagen, esta se conserva.</p>
          </div>
        <% } else { %>
          <p class="note">Este producto no tiene imagen actualmente.</p>
        <% } %>

        <label>
          Reemplazar imagen (opcional)
          <input type="file" name="image" accept=".jpg,.jpeg,.png,.webp" />
        </label>
      </div>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <a href="/admin/products" class="btn-secondary">Cancelar</a>
        <button type="submit" class="btn-primary">Guardar cambios</button>
      </div>
    </form>
  </section>
</main>

<footer class="footer">
  <p>© <%= new Date().getFullYear() %> CalentanaCo · Panel administrativo</p>
</footer>

<script>
  (function () {
    const sizesWrap = document.getElementById("sizesWrap");
    const btnAdd = document.getElementById("btnAddSize");

    function reindex() {
      const rows = sizesWrap.querySelectorAll("[data-row]");
      rows.forEach((row, idx) => {
        const label = row.querySelector('input[name*="[label]"]');
        const price = row.querySelector('input[name*="[price]"]');
        if (label) label.name = `sizes[${idx}][label]`;
        if (price) price.name = `sizes[${idx}][price]`;
      });
    }

    function addRow(labelValue = "", priceValue = "") {
      const row = document.createElement("div");
      row.className = "size-row";
      row.setAttribute("data-row", "1");

      row.innerHTML = `
        <div class="size-col">
          <label>
            Tamaño
            <input type="text" name="sizes[0][label]" placeholder="Ej. 1 Litro" value="${labelValue}">
          </label>
        </div>

        <div class="size-col">
          <label>
            Precio
            <input type="number" step="0.01" name="sizes[0][price]" placeholder="Ej. 35" value="${priceValue}">
          </label>
        </div>

        <div class="size-actions">
          <button type="button" class="btn-danger-outline" data-remove>Quitar</button>
        </div>
      `;

      sizesWrap.appendChild(row);
      reindex();
    }

    // Agregar tamaño
    btnAdd.addEventListener("click", () => addRow());

    // Quitar tamaño
    sizesWrap.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-remove]");
      if (!btn) return;

      const row = btn.closest("[data-row]");
      if (!row) return;

      row.remove();
      reindex();
    });

    // Reindex inicial por seguridad
    reindex();
  })();
</script>

</body>
</html>
